# Pattern Lens

Chrome拡張機能：正規表現とDOM要素検索に対応した高度なページ内検索ツール

## 機能

### 検索機能
- **通常テキスト検索**: ページ内のテキストを検索し、要素境界をまたいだマッチにも対応
- **正規表現検索**: 柔軟なパターンマッチングによる検索
- **要素検索**: CSSセレクタとXPathによるDOM要素の検索
- **大文字小文字の区別**: オプションで大文字小文字を区別した検索が可能

### ハイライト機能
- **オーバーレイ方式**: DOM構造を変更せずに検索結果をハイライト表示
- **現在のマッチの強調**: ナビゲーション中の現在のマッチをオレンジ色で表示
- **ミニマップ表示**: ページ右側に検索結果の位置を一覧表示
- **スクロール/リサイズ対応**: ページのスクロールやウィンドウサイズ変更に自動追従

### ナビゲーション
- **前後移動**: 検索結果間を矢印ボタンまたはキーボードで移動
  - `Enter`: 次のマッチへ移動
  - `Shift+Enter`: 前のマッチへ移動
- **自動スクロール**: 現在のマッチが画面中央に表示されるよう自動スクロール

### その他
- **検索状態の保持**: ポップアップを閉じても検索状態を保持し、再度開いた際に復元
- **カスタマイズ可能**: デフォルト設定をオプションページで保存

## インストール方法

1. このリポジトリをクローンまたはダウンロード
2. Chromeで `chrome://extensions/` を開く
3. 右上の「デベロッパーモード」を有効にする
4. 「パッケージ化されていない拡張機能を読み込む」をクリック
5. プロジェクトのルートディレクトリを選択

## 使い方

### 基本的な検索

1. 拡張機能アイコンをクリックしてポップアップを開く
2. 検索キーワードを入力
3. 「検索」ボタンをクリック

### 正規表現検索

1. 「正規表現」チェックボックスをONにする
2. 正規表現パターンを入力（例: `\d{3}-\d{4}` で郵便番号を検索）
3. 「検索」ボタンをクリック

### 要素検索

1. 「要素検索」チェックボックスをONにする
2. ドロップダウンから「CSSセレクタ」または「XPath」を選択
3. セレクタまたはXPathを入力
   - CSSセレクタ例: `.article > h2`, `#main-content`
   - XPath例: `//div[@class='content']//p`
4. 「検索」ボタンをクリック

### 検索結果のナビゲーション

1. 検索実行後、検索結果の件数と現在位置（例: "1/5"）が表示されます
2. 矢印ボタンまたはキーボードで検索結果間を移動できます
   - `Enter`キー: 次のマッチへ移動
   - `Shift+Enter`キー: 前のマッチへ移動
   - ▼ボタン: 次のマッチへ移動
   - ▲ボタン: 前のマッチへ移動
3. 現在のマッチはオレンジ色で強調表示されます
4. ページ右側のミニマップで全体の検索結果位置を確認できます

### ハイライトのクリア

「検索をクリア」リンクをクリックするか、`Escape`キーを押すと、すべてのハイライトが削除されます。

## 設定

拡張機能アイコンを右クリック → 「オプション」から設定ページを開けます。

- **正規表現をデフォルトで有効**: 拡張機能を開いた際に正規表現モードを自動的にONにします
- **要素検索をデフォルトで有効**: 拡張機能を開いた際に要素検索モードを自動的にONにします

## プロジェクト構成

```
chrome_ext_pattern_lens/
├── manifest.json              # 拡張機能の設定ファイル
├── icons/                     # 拡張機能のアイコン
├── popup/                     # ポップアップUI
│   ├── popup.html
│   └── popup.js
├── options/                   # 設定ページ
│   ├── options.html
│   └── options.js
└── content_scripts/          # コンテンツスクリプト
    └── main.js
```

## 技術スタック

- Manifest V3
- Vanilla JavaScript (フレームワークなし)
- Chrome Extension APIs
  - `chrome.storage.sync`: 設定の保存
  - `chrome.tabs`: タブとの通信
  - `chrome.runtime`: メッセージング

## 技術的な特徴

### 要素境界をまたぐ検索
Chrome標準の検索（Ctrl+F）と同様に、HTML要素の境界をまたいだテキストも検索できます。

**例**: 以下のHTMLで「Hello World」を検索可能
```html
<div>Hello</div><div>World</div>
```

**実装方法**:
- 仮想テキストレイヤーの生成（`createVirtualTextAndMap`関数）
- ブロック要素間に特殊な境界マーカー（`\uE000`）を挿入
- 境界マーカーをまたぐマッチを除外することで、要素内のみのマッチを実現

詳細は [test-cross-element.html](test-cross-element.html) を参照してください。

### オーバーレイ方式のハイライト
DOM構造を一切変更せずにハイライトを実現しています。

**メリット**:
- イベントリスナーやDOMイベントを破壊しない
- CSSスタイルに影響を与えない
- パフォーマンスが良好

**実装方法**:
- `Range.getClientRects()`で検索結果の位置を取得
- `position: absolute`の`div`要素をオーバーレイとして配置
- スクロール/リサイズイベントで位置を自動更新

### ミニマップ機能
ページ右側に検索結果の位置を可視化したミニマップを表示します。

**実装方法**:
- 各検索結果の縦位置をページ全体の高さに対する割合で計算
- 現在のマッチとその他のマッチで色を変えて表示

## 開発

### 必要なツール

- Google Chrome
- テキストエディタ（VS Code、Cursor推奨）

### デバッグ

1. `chrome://extensions/` でデベロッパーモードを有効化
2. 拡張機能の「エラー」リンクでエラーログを確認
3. ポップアップを右クリック → 「検証」でDevToolsを開く
4. コンテンツスクリプトは通常のページDevToolsで確認可能

### リロード

コードを変更した後は、`chrome://extensions/` で拡張機能のリロードボタンをクリックしてください。

### テスト

テスト環境の整備方法については [TESTING_SETUP.md](TESTING_SETUP.md) を参照してください。

### 開発ガイド

詳細な開発ガイドについては [CLAUDE.md](CLAUDE.md) を参照してください。

## ライセンス

MIT License

## 注意事項

- 大量のテキストを含むページでは、検索に時間がかかる場合があります
- 複雑な正規表現はパフォーマンスに影響する可能性があります
- 一部のウェブサイトではContent Security Policyにより動作が制限される場合があります
