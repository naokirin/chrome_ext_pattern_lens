# Pattern Lens

Chrome拡張機能：正規表現とDOM要素検索に対応した高度なページ内検索ツール

## 機能

### 検索機能
- **通常テキスト検索**: ページ内のテキストを検索し、要素境界をまたいだマッチにも対応
- **正規表現検索**: 柔軟なパターンマッチングによる検索
- **要素検索**: CSSセレクタとXPathによるDOM要素の検索
- **大文字小文字の区別**: オプションで大文字小文字を区別した検索が可能

### ハイライト機能
- **オーバーレイ方式**: DOM構造を変更せずに検索結果をハイライト表示
- **現在のマッチの強調**: ナビゲーション中の現在のマッチをオレンジ色で表示
- **ミニマップ表示**: ページ右側に検索結果の位置を一覧表示
- **スクロール/リサイズ対応**: ページのスクロールやウィンドウサイズ変更に自動追従

### ナビゲーション
- **前後移動**: 検索結果間を矢印ボタンまたはキーボードで移動
  - `Enter`: 次のマッチへ移動
  - `Shift+Enter`: 前のマッチへ移動
- **自動スクロール**: 現在のマッチが画面中央に表示されるよう自動スクロール

### その他
- **検索状態の保持**: ポップアップを閉じても検索状態を保持し、再度開いた際に復元
- **カスタマイズ可能**: デフォルト設定をオプションページで保存

## インストール方法

### 開発環境のセットアップ

1. このリポジトリをクローンまたはダウンロード
2. 依存関係をインストール:
   ```bash
   npm install
   ```
3. 開発モードで起動:
   ```bash
   npm run dev
   ```
   これにより、WXTが開発サーバーを起動し、拡張機能を自動的にビルドします。

### 本番ビルド

```bash
npm run build
```

ビルドされた拡張機能は `.output/chrome-mv3/` ディレクトリに生成されます。

### Chromeへの読み込み

1. Chromeで `chrome://extensions/` を開く
2. 右上の「デベロッパーモード」を有効にする
3. 「パッケージ化されていない拡張機能を読み込む」をクリック
4. `.output/chrome-mv3/` ディレクトリを選択（本番ビルドの場合）
   - 開発モードの場合は、WXTが自動的にブラウザを開きます

## 使い方

### 基本的な検索

1. 拡張機能アイコンをクリックしてポップアップを開く
2. 検索キーワードを入力
3. 「検索」ボタンをクリック

### 正規表現検索

1. 「正規表現」チェックボックスをONにする
2. 正規表現パターンを入力（例: `\d{3}-\d{4}` で郵便番号を検索）
3. 「検索」ボタンをクリック

### 要素検索

1. 「要素検索」チェックボックスをONにする
2. ドロップダウンから「CSSセレクタ」または「XPath」を選択
3. セレクタまたはXPathを入力
   - CSSセレクタ例: `.article > h2`, `#main-content`
   - XPath例: `//div[@class='content']//p`
4. 「検索」ボタンをクリック

### 検索結果のナビゲーション

1. 検索実行後、検索結果の件数と現在位置（例: "1/5"）が表示されます
2. 矢印ボタンまたはキーボードで検索結果間を移動できます
   - `Enter`キー: 次のマッチへ移動
   - `Shift+Enter`キー: 前のマッチへ移動
   - ▼ボタン: 次のマッチへ移動
   - ▲ボタン: 前のマッチへ移動
3. 現在のマッチはオレンジ色で強調表示されます
4. ページ右側のミニマップで全体の検索結果位置を確認できます

### ハイライトのクリア

「検索をクリア」リンクをクリックするか、`Escape`キーを押すと、すべてのハイライトが削除されます。

## 設定

拡張機能アイコンを右クリック → 「オプション」から設定ページを開けます。

- **正規表現をデフォルトで有効**: 拡張機能を開いた際に正規表現モードを自動的にONにします
- **要素検索をデフォルトで有効**: 拡張機能を開いた際に要素検索モードを自動的にONにします

## プロジェクト構成

```
chrome_ext_pattern_lens/
├── entrypoints/              # WXTエントリーポイント
│   ├── popup/                # ポップアップUI
│   │   ├── index.html
│   │   └── main.ts
│   ├── options/              # 設定ページ
│   │   ├── index.html
│   │   └── main.ts
│   └── content.ts           # コンテンツスクリプト
├── lib/                      # 共通ライブラリ
│   └── types.ts             # 型定義
├── public/                   # 静的リソース
│   └── icons/               # 拡張機能のアイコン
├── tests/                   # テストファイル
├── wxt.config.ts            # WXT設定ファイル
├── tsconfig.json            # TypeScript設定
└── package.json             # 依存関係
```

## 技術スタック

- **WXT**: Chrome拡張機能開発フレームワーク
- **TypeScript**: 型安全な開発
- **Manifest V3**: 最新のChrome拡張機能仕様
- **Vitest**: テストフレームワーク
- **Chrome Extension APIs**
  - `chrome.storage.sync`: 設定の保存
  - `chrome.tabs`: タブとの通信
  - `chrome.runtime`: メッセージング

## 技術的な特徴

### 要素境界をまたぐ検索
Chrome標準の検索（Ctrl+F）と同様に、HTML要素の境界をまたいだテキストも検索できます。

**例**: 以下のHTMLで「Hello World」を検索可能
```html
<div>Hello</div><div>World</div>
```

**実装方法**:
- 仮想テキストレイヤーの生成（`createVirtualTextAndMap`関数）
- ブロック要素間に特殊な境界マーカー（`\uE000`）を挿入
- 境界マーカーをまたぐマッチを除外することで、要素内のみのマッチを実現

詳細は [test-cross-element.html](test-cross-element.html) を参照してください。

### オーバーレイ方式のハイライト
DOM構造を一切変更せずにハイライトを実現しています。

**メリット**:
- イベントリスナーやDOMイベントを破壊しない
- CSSスタイルに影響を与えない
- パフォーマンスが良好

**実装方法**:
- `Range.getClientRects()`で検索結果の位置を取得
- `position: absolute`の`div`要素をオーバーレイとして配置
- スクロール/リサイズイベントで位置を自動更新

### ミニマップ機能
ページ右側に検索結果の位置を可視化したミニマップを表示します。

**実装方法**:
- 各検索結果の縦位置をページ全体の高さに対する割合で計算
- 現在のマッチとその他のマッチで色を変えて表示

## 開発

### 必要なツール

- Node.js (v18以上推奨)
- npm または yarn
- Google Chrome
- テキストエディタ（VS Code、Cursor推奨）

### 開発コマンド

```bash
# 依存関係のインストール
npm install

# 開発モード（HMR対応）
npm run dev

# 本番ビルド
npm run build

# テスト実行
npm test

# テスト（ウォッチモード）
npm run test:watch

# テスト（UI）
npm run test:ui

# カバレッジレポート
npm run test:coverage
```

### 開発の流れ

1. `npm run dev`で開発サーバーを起動
2. WXTが自動的にブラウザを開き、拡張機能を読み込みます
3. コードを変更すると、HMR（Hot Module Replacement）により自動的にリロードされます
4. `.output/chrome-mv3/`ディレクトリにビルド結果が生成されます

### デバッグ

1. `chrome://extensions/` でデベロッパーモードを有効化
2. 拡張機能の「エラー」リンクでエラーログを確認
3. ポップアップを右クリック → 「検証」でDevToolsを開く
4. コンテンツスクリプトは通常のページDevToolsで確認可能
5. 開発モードでは、WXTが自動的にリロードするため手動リロードは不要

### テスト

テスト環境の整備方法については [TESTING_SETUP.md](TESTING_SETUP.md) を参照してください。

### 開発ガイド

詳細な開発ガイドについては [CLAUDE.md](CLAUDE.md) を参照してください。

## ライセンス

MIT License

## 注意事項

- 大量のテキストを含むページでは、検索に時間がかかる場合があります
- 複雑な正規表現はパフォーマンスに影響する可能性があります
- 一部のウェブサイトではContent Security Policyにより動作が制限される場合があります
