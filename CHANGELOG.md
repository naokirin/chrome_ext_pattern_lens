# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [1.2.1] - 2025-12-25

### 修正 (Fixed)

- **スクロール時の検索結果数値表示とminimapの更新**: スクロール時にminimapが更新され、検索結果数値が正しく表示されるように修正
  - DOM変更検出時の再検索で検索完了後に通知を送るように修正
  - searchFunctionにonCompleteコールバックを追加し、非同期検索完了後に正しい検索結果数を通知
  - これにより、スクロール時に検索結果数値が0/0になる問題を解消

### 改善 (Improved)

- **スクロール時のオーバーレイ追従遅延**: オーバーレイ位置の更新方式を改善し、スクロール時の追従遅延を解消
  - オーバーレイ位置を直接更新する方式に変更（再作成を回避）
  - オーバーレイとRange/Elementのマッピングを管理して効率的に更新
  - スクロールイベントハンドラを最適化し、即座に更新するように改善
  - 複数行にまたがる検索結果でも正しく位置更新されるように修正
- **オーバーレイの状態管理**: range/elementがない場合にコンテナをクリアする処理を追加
  - updateOverlayPositionsでrange/elementがない場合にコンテナをクリア
  - オーバーレイマッピングもクリアして状態をリセット

## [1.2.0] - 2025-12-25

### 追加 (Added)

#### あいまい検索の機能拡張
- **上付き・下付き・丸数字の正規化**: 上付き数字（¹、²、³、⁰-⁹）、下付き数字（₀-₉）、丸数字（①-⑳、⓫-⓴、⓵-⓿）を通常の数字に正規化して検索可能に
- **数字の区切り文字と小数点の違いを吸収**: カンマ区切り（1,000）とピリオド区切り（1.000）の数字を統一して検索可能に
  - 小数点を含む数字（1,234.56）の正規化に対応
  - ヨーロッパ形式の小数点（1.234,56）にも対応
  - 千の区切り文字と小数点を自動判別するロジックを実装

### 修正 (Fixed)

- **あいまい検索の数字マッチング**: あいまい検索で1,234,56が1,234,567にマッチするように修正

### 改善 (Improved)

- **ドキュメントの更新**: README.mdと設定ページにあいまい検索の新機能の仕様を追加
- **テストケースの追加**: 上付き・下付き・丸数字、数字の区切り文字に関するテストケースを追加

## [1.1.1] - 2024-12-XX

### 修正 (Fixed)

- **インストール時点で既に開いているページでの動作**: 拡張機能をインストールした時点で既に開いているページでも、ページをリロードせずにcontent scriptを自動注入して動作するように修正
  - `scripting`権限を追加してcontent scriptの動的注入を可能に
  - content scriptの存在確認と自動注入機能を実装
  - すべてのメッセージ送信前にcontent scriptの読み込みを確認
  - WXTのビルド後の正しいファイルパス（`content-scripts/content.js`）を使用
  - エラーメッセージの国際化対応を追加

## [1.1.0] - 2024-12-XX

### 追加 (Added)

#### 国際化対応
- **英語対応**: 英語と日本語の2言語に対応（ブラウザの言語設定に基づいて自動切り替え）

#### 検索機能
- **Ctrl+Fオーバーライド機能**: ブラウザの標準検索（Ctrl+F）を拡張機能の検索に置き換える機能（デフォルトOFF、設定ページで有効化可能）
- **あいまい検索の機能拡張**:
  - アクセント付き文字と代用表記に対応（例: `é`と`e`、`à`と`a`の相互マッチ）
  - アクセント付き文字の双方向マッチングと大文字小文字の区別なし検索を実装
  - ひらがな・カタカナと大文字小文字の相互一致を追加
  - あいまい検索の範囲設定を追加（設定ページで調整可能）

#### 設定機能
- **独立した設定ページ**: オプションページを独立した設定ページ（settings）に変更
- **デフォルト検索オプションの設定**: 設定ページでデフォルトの検索オプションを設定可能
- **あいまい検索の仕様説明**: 設定ページにあいまい検索の仕様と排他制御の説明を追加

### 修正 (Fixed)

- **検索結果一覧のON/OFF状態保持**: 検索結果一覧のON/OFF状態を保持するように修正
- **lintエラーの修正**: Biomeのlintエラーを修正

### 改善 (Improved)

- **アクセント付き文字検索のパフォーマンス**: アクセント付き文字検索のパフォーマンスを最適化
- **設定画面のUI改善**:
  - 自動保存表示をビューポート下部に固定表示
  - labelと仕様説明文のフォントサイズを大きくする
- **UX改善**: chipクリック時にテキスト入力欄にフォーカスを戻すように修正

### テスト

- **テストケースの追加**: 優先度の高いテストケースを追加
- **テストケースの拡充**: 優先度: 中・低のテストケースを実装
- **あいまい検索のテスト**: あいまい検索の正規化パターンのテストケースを追加

---

## [1.0.0] - 2024-12-XX

### 追加 (Added)

#### 検索機能
- **通常テキスト検索**: ページ内のテキストを検索し、要素境界をまたいだマッチにも対応
- **正規表現検索**: 柔軟なパターンマッチングによる検索
- **要素検索**: CSSセレクタとXPathによるDOM要素の検索
- **大文字小文字の区別**: オプションで大文字小文字を区別した検索が可能
- **あいまい検索**: 表記ゆれやフォーマットの差異を吸収した検索
  - 複数キーワードの範囲検索（空白で区切ったキーワードが一定範囲内に存在する場合にマッチ）
  - 記号の表記ゆれ吸収（ハイフン、伸ばし棒などの半角・全角の差異）
  - 文字種の表記ゆれ吸収（アルファベット、数字、カタカナの全角・半角の差異）
  - ひらがなとカタカナの相互マッチ
  - 濁点・半濁点の結合文字正規化（別文字の濁点（゛）や半濁点（゜）がある場合に、結合した1文字と同じ判定にする。例: 「か゛」や「ｶﾞ」を「が」として扱う）
- **検索結果一覧**: 検索結果を一覧表示し、前後文脈とともに確認可能
  - 一覧から選択した結果の位置にジャンプ
  - 前後文脈の文字数を設定可能（デフォルト30文字、10〜100文字）
  - 要素検索でも検索結果一覧を利用可能

#### ハイライト機能
- **オーバーレイ方式**: DOM構造を変更せずに検索結果をハイライト表示
- **現在のマッチの強調**: ナビゲーション中の現在のマッチをオレンジ色で表示
- **ミニマップ表示**: ページ右側に検索結果の位置を一覧表示
- **スクロール/リサイズ対応**: ページのスクロールやウィンドウサイズ変更に自動追従
- **動的要素検索の自動更新**: DOM変更を検知して自動的に再検索を実行

#### ナビゲーション機能
- **前後移動**: 検索結果間を矢印ボタンまたはキーボードで移動
  - `Enter`: 次のマッチへ移動
  - `Shift+Enter`: 前のマッチへ移動
- **自動スクロール**: 現在のマッチが画面中央に表示されるよう自動スクロール
- **検索状態の保持**: ポップアップを閉じても検索状態を保持し、再度開いた際に復元

#### UI/UX
- **自動検索**: 入力変更時に自動的に検索を実行（デバウンス機能付き）
- **チェックボックス変更時の自動検索**: オプション変更時に自動的に再検索
- **検索結果表示の改善**: 件数メッセージを削除し、x/y表示で状態を表示
- **Chipsスタイルのチェックボックス**: UIの視認性を向上

#### 設定機能
- **デフォルト設定の保存**: chrome.storage.syncを使用してデフォルト設定を保存
  - 正規表現をデフォルトで有効
  - 大文字小文字を区別する検索をデフォルトで有効
  - 要素検索をデフォルトで有効
  - 検索結果一覧の前後文脈の文字数（デフォルト30文字）

#### 開発環境
- **WXTフレームワーク**: Chrome拡張機能開発フレームワークの導入
- **TypeScript化**: 全コードをTypeScriptに移行
- **テスト環境**: Vitestを使用したユニットテストと統合テスト
- **コード品質**: Biomeを使用したlintとフォーマット
- **テストカバレッジ**: 主要機能のテストカバレッジを実装

### 修正 (Fixed)

- **スクロール時のハイライト位置ずれ**: スクロール時にハイライトが正しい位置に表示されるよう修正
- **overflow非表示要素のハイライト表示**: overflowで非表示になっている要素も正しくハイライト表示
- **再検索後の現在位置維持**: 再検索後に以前のcurrentIndexを維持し、現在のスクロール位置に最も近いマッチを選択
- **DOM変更による再検索後のポップアップ表示更新**: 動的要素検索の自動更新後にポップアップの表示を正しく更新
- **レート制限のバグ修正**: 動的要素検索のレート制限を修正し、応答性を改善
- **正規表現のメタ文字エスケープ**: 通常検索モードで正規表現のメタ文字が正しく解釈されるよう修正
- **要素境界の検出**: ブロック要素の境界を正しく検出し、要素境界をまたぐ検索を実現
- **重複文字列の除外**: 複数キーワード検索で重複文字列を除外
- **型エラーの修正**: TypeScriptの型エラーを修正
- **lintエラーの修正**: Biomeのlintエラーを修正

### 改善 (Improved)

- **パフォーマンス最適化**: オーバーレイ位置更新にスロットルを適用
- **コードの整理**: 関数の責務を分割し、単一責任の原則に従った設計に改善
- **仮想テキスト生成の複雑さを改善**: 関数を分割して可読性を向上
- **テストしにくい設計を改善**: グローバル依存を関数化してモック可能に
- **エラーハンドリングの統一**: エラーハンドリングを統一し、ユーザー体験を向上
- **メッセージハンドリングの改善**: メッセージハンドリングのコードを整理
- **定数の集約**: 定数を集約して保守性を向上
- **DOM要素取得の型安全性向上**: TypeScriptの型安全性を向上
- **重複コードの削減**: 重複コードを共通ユーティリティ関数に抽出
- **イベントリスナーの重複登録防止**: イベントリスナーの重複登録を防止
- **開発環境と本番環境でCSP設定を分離**: セキュリティを向上

### 技術的な詳細

#### アーキテクチャ
- **Manifest V3**: 最新のChrome拡張機能仕様に対応
- **WXTフレームワーク**: モダンなChrome拡張機能開発フレームワークを採用
- **TypeScript**: 型安全な開発環境
- **モジュール分割**: 機能ごとにモジュールを分割し、保守性を向上

#### 実装の特徴
- **要素境界をまたぐ検索**: 仮想テキストレイヤーを生成し、HTMLのインライン要素の境界をまたいだテキストも検索可能
- **オーバーレイ方式のハイライト**: DOM構造を一切変更せずにハイライトを実現（イベントリスナーやDOMイベントを破壊しない）
- **動的要素検索**: DOM変更を検知して自動的に再検索を実行

### ドキュメント

- **README.md**: プロジェクトの概要、インストール方法、使い方を記載
- **CLAUDE.md**: Claude Code/Cursorでの開発ガイド
- **設計ドキュメント**: あいまい検索、検索結果一覧、動的要素検索改善計画などの設計ドキュメント

### ライセンス

- **MIT License**: MITライセンスを採用

---

[1.2.1]: https://github.com/naokirin/chrome_ext_pattern_lens/releases/tag/v1.2.1
[1.2.0]: https://github.com/naokirin/chrome_ext_pattern_lens/releases/tag/v1.2.0
[1.1.1]: https://github.com/naokirin/chrome_ext_pattern_lens/releases/tag/v1.1.1
[1.1.0]: https://github.com/naokirin/chrome_ext_pattern_lens/releases/tag/v1.1.0
[1.0.0]: https://github.com/naokirin/chrome_ext_pattern_lens/releases/tag/v1.0.0
